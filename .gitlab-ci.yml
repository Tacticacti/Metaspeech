image: node:20.0.0

# cache: #  Parameter 'cache' to cache the installation files for your projects dependencies, for building faster
#   paths:
#     - graphgadget/

stages:
  - prepare
  - check
  - build
  - test
  - deploy

prepare:
  stage: prepare
  script:
    - cd graphgadget
    - npm ci
    - npx playwright install --with-deps
  artifacts:
   paths:
   - graphgadget/node_modules
   - ~/.cache/ms-playwright/
  cache:
   paths:
   - ~/.cache/ms-playwright/

check:
  stage: check
  script:
    - cd graphgadget
    - npm run lint

build:
  stage: build
  script:
    - cd graphgadget
    - npm run build
  artifacts:
   paths: 
     - graphgadget/build # used for deploying
     - graphgadget/.svelte-kit/tsconfig.json # used by testing

test:
  stage: test
  script: 
    - cd graphgadget
    - npm run test
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: graphgadget/coverage/cobertura-coverage.xml
  coverage: '/^Statements\s*:\s*([^%]+)/'

pages:
  stage: deploy
  script:
  - mkdir .public
  - cp -r graphgadget/build/* .public
  - mv .public public
  artifacts:
    paths:
    - public
  only:
    - dev
